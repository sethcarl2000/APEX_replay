#!/bin/bash

#SBATCH --nodes 1
#SBATCH --partition production
#SBATCH --account halla
#SBATCH --ntasks 1
#SBATCH --cpus-per-task 1
#SBATCH --output=/volatile/halla/apex/full_replay/slurm/out/%x.%j.out
#SBATCH --error=/volatile/halla/apex/full_replay/slurm/err/%x.%j.err
#SBATCH --time=5:00:00
#SBATCH --mem-per-cpu=4250

run=$1

CHUNK_SIZE=90000
MAX_CHUNK_SIZE=110000

#find all the coda-files we're gonna 'decode' 
ls $RAWFILE_DIR/apex_$run.* > $VOLATILE_DIR/coda_files.$run.list

i_coda=-1

event_coda_first=0 

while read -r file_coda; do
    
    echo "analyzing coda file '$file_coda'...."
    
    let i_coda++ #index we assign to the current coda-file
    
    #let's find out how many raw events are in this coda file
    file_eventCount=$VOLATILE_DIR/nEvts.$run.$i_coda.txt 
    
    analyzer -l -b -q 'count_events.C("'$file_coda'")' > $file_eventCount
    
    nEvents=$(sed -n -e 's/.*NUM_EVENTS_READ=//p' $file_eventCount) 
    
    let event_coda_last=$(( $event_coda_first + $nEvents ))
    
    rm $file_eventCount
    
    echo "number of events found: $nEvents" 
    
    let event_first=$event_coda_first
    
    i_chunk=-1
    
    is_last_chunk="false"
    
    #process each event in 'chunks' 
    while [[ $is_last_chunk == "false" ]]; do 
	
	let i_chunk++  #index of 'chunk' we will be working with 
        
	let events_remain=$(( $event_coda_last - $event_first )) 
	
	if [[ $events_remain -lt $MAX_CHUNK_SIZE ]] 
	then 
	    echo "this is the last chunk. size=$events_remain"
	    let event_last=$event_coda_last
	    
	    is_last_chunk="true"
	else 
	    echo "this is not the last chunk. size=$CHUNK_SIZE" 
	    let event_last=$(( $event_first + $CHUNK_SIZE ))
	fi 
	
	let chunkSize=$(( $event_last - $event_first ))
	
	file_decode=$VOLATILE_DIR/production/decode.$run.coda-$i_coda.part-$i_chunk.root
	file_replay=$VOLATILE_DIR/production/replay.$run.coda-$i_coda.part-$i_chunk.root 
	echo "file_decode: $file_decode"
	echo "file_replay: $file_replay" 
	
	echo "Decoding coda-file, chunk $i_chunk, events [$event_first, $event_last] (chunk size=$chunkSize)..."
		
	#decode the coda-file
	analyzer -l -b -q 'setup_fullReplay.C("'$file_coda'","'$file_decode'",'$event_first','$event_last')' 
		
	#check to make sure the decode-file exists
	if test -f $file_decode; 
	then 
	    
	    #now, we can replay the file
	    echo "decode file sucessfully created. replaying...." 
	    
	    analyzer -l -b -q 'track_replay_macro.C("'$file_decode'","'$file_replay'",'$run')'
	    rm $file_decode
	    
	else
	    echo "ERROR! decode file '$file_decode' not found.\n, Perhaps the decode-macro failed?"
	fi 
	
	let event_first=$(( $event_last + 1 ))
	
    done 

    let event_coda_first=$(( $event_coda_last + 1 ))
    
done < ''$VOLATILE_DIR'/coda_files.'$run'.list'

echo "done replaying all coda-files. now let's 'hadd' the result..." 

rm $VOLATILE_DIR/coda_files.$run.list

#now, 'hadd' the runs together
script_haddReplay.sh $run $run 

echo "done." 
