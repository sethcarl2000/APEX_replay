#ifndef Podd_TReactVertex_h_
#define Podd_TReactVertex_h_

//////////////////////////////////////////////////////////////////////////
//
// TReactVertex
// Handles computation of the react vertex. 
//
//////////////////////////////////////////////////////////////////////////

//#include "THaPhysicsModule.h"
#include "TObject.h"
#include "TVector3.h"
#include "TVector2.h"
#include "RMatrixD.h"
#include "TString.h" 
#include <vector> 
#include <map> 

//_________________________________________________________________________________
class TReactVertex : public TObject { 

public:
  
  TReactVertex() {};
  
  enum EOpticsTarget { kNone=0, kV1,kV2,kV3, kH1,kH2,kH3,kH4 }; 
  
  TReactVertex(bool isRHRS,
	       TString path_decode,
	       TString target="",
	       TString treeName="T");
  
  ~TReactVertex() {}; 
  
  TVector3 Compute_reactVertex(double rastX,
			       double rastY) const; 
  
  TVector2 Get_beamCenter() const; 

  TVector2 Get_rasterAmplitude() const { return fRaster_amplitude; } 
  
  struct OpticsWire_t {
    TString name;
    bool isVertical; 
    double x,y,z;
  };  

  //not sure if i'll ever need these methods, but they might be useful 
  bool IsWireMode() const { return f_isWireMode; }
  OpticsWire_t Get_wire() const; 
  
private:

  TString fTargetName;
  bool f_isWireMode; 
  
  OpticsWire_t fWire;

  const std::map<TString,TReactVertex::OpticsWire_t> fWireMap = {
    {"V1", {.name="V1", .isVertical=true,  .x=-3.225e-3, .y= 0e-3,     .z=-196.214e-3}},
    {"V2", {.name="V2", .isVertical=true,  .x=-0.725e-3, .y= 0e-3,     .z=   3.786e-3}},
    {"V3", {.name="V3", .isVertical=true,  .x= 1.725e-3, .y= 0e-3,     .z= 203.786e-3}},
    {"H1", {.name="H1", .isVertical=false, .x= 0e-3,     .y=-7.660e-3, .z=-241.249e-3}},
    {"H2", {.name="H2", .isVertical=false, .x= 0e-3,     .y=-2.676e-3, .z= -91.204e-3}},
    {"H3", {.name="H3", .isVertical=false, .x= 0e-3,     .y= 2.324e-3, .z= 108.750e-3}},
    {"H4", {.name="H4", .isVertical=false, .x= 0e-3,     .y= 7.328e-3, .z= 258.746e-3}}
  }; 
    
  TVector2 fBeamCenter;  //center of beam at target (z_HCS = 0) 
  TVector2 fBeam_dXdz;
  
  RMatrixD fMatrix_rast; //channel (dc) to meter (dX) conversion
  
  RMatrixD fMatrix_BPMA; //correction matrix for BPM readouts
  ROOT::RVec<double> fR0_BPMA, fR_BPMA;
  
  RMatrixD fMatrix_BPMB; //correction matrix for BPM readouts
  ROOT::RVec<double> fR0_BPMB, fR_BPMB; 

  //z-positions of BPMs (relative to apex scattering chamber)
  const double fA_z = -7.354 + 1.0537;
  const double fB_z = -2.215 + 1.0537;

  TVector2 fRast_avg; 

  //the x-y span of the raster, throughout the run (in HCS)
  TVector2 fRaster_amplitude; 
  
  ClassDef(TReactVertex,0); 
};
//_________________________________________________________________________________

#endif
